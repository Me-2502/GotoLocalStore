<div class="container my-5">
    <h2 class="mb-4 text-primary fw-bold">Checkout</h2>

    <!-- Step 1: Delivery Details -->
    <form [formGroup]="checkoutForm" *ngIf="step === 1" (ngSubmit)="goToStep2()" class="needs-validation" novalidate>
        <div class="mb-3">
            <label for="fullName" class="form-label fw-semibold">Full Name</label>
            <input id="fullName" formControlName="fullName" type="text" class="form-control" readonly />
        </div>

        <div class="mb-3">
            <label for="phone" class="form-label fw-semibold">Phone Number</label>
            <input id="phone" formControlName="phone" type="tel" maxlength="10" class="form-control" readonly />
        </div>

        <div class="mb-3">
            <label for="address" class="form-label fw-semibold">Delivery Address</label>
            <textarea id="address" formControlName="address" rows="3" class="form-control" [ngClass]="{ 'is-invalid': checkoutForm.get('address')?.touched && checkoutForm.get('address')?.invalid }"></textarea>
            <div *ngIf="checkoutForm.get('address')?.touched && checkoutForm.get('address')?.invalid" class="invalid-feedback">
                Address is required.
            </div>
            <button *ngIf="user?.address" type="button" class="btn btn-outline-primary mt-2" (click)="setAddress()">Use your address</button>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <label for="deliveryDate" class="form-label fw-semibold">Delivery Date</label>
                <input id="deliveryDate" formControlName="deliveryDate" type="date" class="form-control" readonly />
            </div>
            <div class="col-md-6">
                <label for="totalPrice" class="form-label fw-semibold">Total Price</label>
                <input id="totalPrice" type="text" class="form-control" [value]="totalPrice | currency:'INR'" readonly />
            </div>
        </div>

        <div class="d-flex gap-3">
            <button class="btn btn-outline-secondary flex-grow-1" type="button" (click)="cancelPayment()">
                Cancel
            </button>
            <button class="btn btn-primary flex-grow-1" type="submit">
                Continue to Payment
            </button>
        </div>
    </form>

    <!-- Step 2: Payment Methods -->
    <div *ngIf="step === 2">
        <h4 class="mb-4 text-primary fw-semibold">Select Payment Method</h4>
        <ul class="list-group mb-4 shadow-sm">
            <li class="list-group-item" *ngFor="let method of paymentMethods" (click)="selectPaymentMethod(method)"
                style="cursor:pointer;">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fs-5">{{ method }}</span>
                    <span *ngIf="selectedMethod === method" class="badge bg-light text-primary">Selected</span>
                </div>

                <div *ngIf="selectedMethod === method" class="mt-3 ps-3 border-start border-3 border-primary">
                    <!-- Cash on Delivery -->
                    <div *ngIf="method === 'Cash on Delivery'">
                        <p class="mb-3">
                            Amount to be paid on delivery:
                            <strong>{{ totalPrice | currency:'INR' }}</strong>
                        </p>
                        <button class="btn btn-success me-2" (click)="confirmCOD()" type="button">
                            Place Order
                        </button>
                    </div>

                    <!-- Card Payment -->
                    <form [formGroup]="paymentForm" *ngIf="method === 'Credit Card' || method === 'Debit Card'"
                        (ngSubmit)="submitPayment()" class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label for="cardNumber" class="form-label fw-semibold">Card Number</label>
                            <input id="cardNumber" formControlName="cardNumber" type="text" maxlength="16"
                                class="form-control" [ngClass]="{
                    'is-invalid':
                      paymentForm.get('cardNumber')?.touched &&
                      paymentForm.get('cardNumber')?.invalid
                  }" />
                            <div *ngIf="
                    paymentForm.get('cardNumber')?.touched &&
                    paymentForm.get('cardNumber')?.invalid
                  " class="invalid-feedback">
                                Card Number is required and must be 16 digits.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="expiry" class="form-label fw-semibold">Expiry Date (MM/YY)</label>
                            <input id="expiry" formControlName="expiry" type="text" placeholder="MM/YY"
                                class="form-control" [ngClass]="{ 'is-invalid': paymentForm.get('expiry')?.touched && paymentForm.get('expiry')?.invalid }" />
                            <div *ngIf="paymentForm.get('expiry')?.touched && paymentForm.get('expiry')?.invalid" class="invalid-feedback">
                                Expiry date is required and must be in MM/YY format.
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="cvv" class="form-label fw-semibold">CVV</label>
                            <input id="cvv" formControlName="cvv" type="password" maxlength="4" class="form-control"
                                [ngClass]="{ 'is-invalid': paymentForm.get('cvv')?.touched && paymentForm.get('cvv')?.invalid }" />
                            <div *ngIf="paymentForm.get('cvv')?.touched && paymentForm.get('cvv')?.invalid" class="invalid-feedback">
                                CVV is required and must be 3 or 4 digits.
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-success flex-grow-1" type="submit">Submit Payment</button>
                            <button class="btn btn-outline-secondary flex-grow-1" (click)="resetPayment()" type="button">Reset</button>
                        </div>
                    </form>

                    <!-- UPI Payment -->
                    <form [formGroup]="paymentForm" *ngIf="method === 'UPI'" (ngSubmit)="submitPayment()"
                        class="needs-validation" novalidate>
                        <div class="mb-4">
                            <label for="upiId" class="form-label fw-semibold">UPI ID</label>
                            <input id="upiId" formControlName="upiId" type="text" placeholder="example@upi"
                                class="form-control" [ngClass]="{
                    'is-invalid':
                      paymentForm.get('upiId')?.touched &&
                      paymentForm.get('upiId')?.invalid
                  }" />
                            <div *ngIf="
                    paymentForm.get('upiId')?.touched &&
                    paymentForm.get('upiId')?.invalid
                  " class="invalid-feedback">
                                UPI ID is required.
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-success flex-grow-1" type="submit">
                                Submit Payment
                            </button>
                            <button class="btn btn-outline-secondary flex-grow-1" (click)="resetPayment()"
                                type="button">
                                Reset
                            </button>
                        </div>
                    </form>
                </div>
            </li>
        </ul>

        <div class="d-flex gap-3">
            <button class="btn btn-outline-secondary flex-grow-1" (click)="step = 1">Back to Delivery Details</button>
            <button class="btn btn-danger flex-grow-1" (click)="cancelPayment()" type="button">Cancel payment</button>
        </div>
    </div>
</div>